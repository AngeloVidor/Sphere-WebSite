@model SphereWebSite.Data.Models.GroupPostCommentsViewModel

<div class="post-details">
    <h1>@Model.GroupPost.Title</h1>
    <p>@Model.GroupPost.Description</p>

    @if (!string.IsNullOrEmpty(Model.GroupPost.ImageUrl))
    {
        <img src="@Model.GroupPost.ImageUrl" alt="@Model.GroupPost.Title" class="img-fluid rounded" style="max-height: 400px; width: auto; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#imageModal" />
    }

    <div class="post-meta">
        <small>Posted on @Model.GroupPost.CreatedAt.ToString("dd/MM/yyyy")</small>
    </div>

    <hr />

    <h3>Comments</h3>
    <ul id="comments-list">
        @foreach (var comment in Model.Comments)
        {
            <li class="comment" data-comment-id="@comment.CommentID">
                <p>@comment.Content</p>
                <small>Commented by @comment.User.NickName on @comment.CreatedAt.ToString("dd/MM/yyyy")</small>
                <button class="btn-dropdown" data-comment-id="@comment.CommentID">...</button>
                <div class="dropdown-content" style="display:none;">
                    <button class="delete-comment-btn" data-comment-id="@comment.CommentID">Delete Comment</button>
                </div>
            </li>
        }
    </ul>

    <hr />

    <h4>Add Comment</h4>
    @if (User.Identity.IsAuthenticated) 
    {
        <form id="commentForm">
            <div class="form-group">
                <label for="content">Comment:</label>
                <textarea id="content" name="content" class="form-control" rows="3" required></textarea>
            </div>
            <input type="hidden" id="groupPostId" value="@Model.GroupPost.GroupPostID" />
            @Html.AntiForgeryToken() <!-- Token CSRF -->
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    }
    else
    {
        <p>You need to be <a href="/Users/Login">logged in</a> to comment.</p>
    }

    <div id="commentSuccessMessage" style="display:none;">Comment added successfully!</div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">@Model.GroupPost.Title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <img src="@Model.GroupPost.ImageUrl" alt="@Model.GroupPost.Title" class="img-fluid" />
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#commentForm').submit(function(event) {
            event.preventDefault();

            var postId = $('#groupPostId').val();
            var content = $('#content').val();
            var token = $('input[name="__RequestVerificationToken"]').val(); 

            $.ajax({
                url: '/GroupFeedComments/Create',
                type: 'POST',
                data: { 
                    groupPostID: postId, 
                    content: content, 
                    __RequestVerificationToken: token 
                },
                success: function(response) {
                    if (response.success) {
                        $('#comments-list').append(`
                            <li class="comment" data-comment-id="${response.comment.CommentID}">
                                <p>${response.comment.Content}</p>
                                <small>Commented by you now</small>
                                <button class="btn-dropdown" data-comment-id="${response.comment.CommentID}">...</button>
                                <div class="dropdown-content" style="display:none;">
                                    <button class="delete-comment-btn" data-comment-id="${response.comment.CommentID}">Delete Comment</button>
                                </div>
                            </li>
                        `);
                        $('#content').val('');
                        $('#commentSuccessMessage').text('Comment added successfully!').show().delay(2000).fadeOut();
                    } else {
                        $('#commentSuccessMessage').text(response.message).show().delay(2000).fadeOut();
                    }
                },
                error: function(xhr) {
                    console.error("Error details:", xhr);
                    $('#commentSuccessMessage').text('Error adding comment. Please try again.').show().delay(2000).fadeOut();
                }
            });
        });

        $(document).on('click', '.btn-dropdown', function() {
            $(this).siblings('.dropdown-content').toggle();
        });

        $(document).on('click', '.delete-comment-btn', function() {
            var commentId = $(this).data('comment-id');
            if (confirm('Are you sure you want to delete this comment?')) {
                $.ajax({
                    url: '/GroupFeedComments/DeleteComment',
                    type: 'POST',
                    data: { commentId: commentId },
                    success: function(response) {
                        if (response.success) {
                            $('li.comment[data-comment-id="' + commentId + '"]').remove();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function(xhr) {
                        alert('Error deleting comment. Please try again.');
                    }
                });
            }
        });
    });
</script>

<style>
    body {
        background-color: #121212;
        color: #e0e0e0;
    }

    .post-details {
        max-width: 800px; 
        margin: auto;
        padding: 20px;
        background-color: #1e1e1e;
        border-radius: 8px; 
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); 
    }

    h1, h3, h4 {
        color: #ffcc00; 
    }

    .post-meta {
        margin: 10px 0;
        font-size: 0.9em; 
        color: #bbb; 
    }

    .comment {
        background-color: #292929; 
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px; 
    }

    .btn-dropdown {
        cursor: pointer;
        color: #ffcc00; 
        background: none;
        border: none;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #333;
        border-radius: 4px;
        min-width: 120px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1;
    }

    .dropdown-content button {
        color: white; 
        padding: 10px; 
        text-align: left; 
        border: none; 
        background: none;
        width: 100%; 
    }

    .dropdown-content button:hover {
        background-color: #444; 
    }

    #commentSuccessMessage {
        color: green; 
        margin-top: 10px;
    }
</style>
